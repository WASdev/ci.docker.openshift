FROM websphere-liberty:javaee7
# Install Maven
RUN apt-get update
RUN apt-get -y install maven
RUN mkdir -p /opt/s2i/destination
RUN JAVA_VRMF=$JAVA_VER.$JAVA_REL-$JAVA_MF
RUN YML_FILENAME=ibm-java-sdk-$JAVA_VRMF-linux-$TARGET_ARCH-javase.yml
RUN BASE_URL="https://public.dhe.ibm.com/ibmdl/export/pub/systems/cloud/runtimes/java/meta"
RUN wget -q -U UA-IBM_JAVA_Docker -O /tmp/ibm-java.yml $BASE_URL/$JAVA_VER$JAVA_REL/$YML_FILENAME
RUN JAVA_URL=$(cat /tmp/ibm-java.yml | sed -n 's/\s*uri:\s//p' | tr -d '\r')
RUN wget -q -U UA-IBM-JAVA-Docker -O /tmp/ibm-java.bin $JAVA_URL
RUN ESUM=$(cat /tmp/ibm-java.yml | sed -n 's/\s*md5sum:\s//p' | tr -d '\r')
RUN echo "$ESUM /tmp/ibm-java.bin" | md5sum -c -
RUN rm -f /tmp/ibm-java.yml
RUN echo "INSTALLER_UI=silent" > /tmp/response.properties
RUN echo "USER_INSTALL_DIR=/opt/ibm/java" >> /tmp/response.properties
RUN echo "LICENSE_ACCEPTED=TRUE" >> /tmp/response.properties
RUN mkdir -p /opt/ibm
RUN chmod +x /tmp/ibm-java.bin
RUN /tmp/ibm-java.bin -i silent -f /tmp/response.properties
RUN rm -f /tmp/response.properties
RUN rm -f /tmp/ibm-java.bin
ENV JAVA_HOME=/opt/ibm/java \
    PATH=/opt/ibm/java/jre/bin:$PATH

LABEL io.k8s.description="Platform for building and running JEE applications on WebSphere Liberty" \
      io.k8s.display-name="WebSphere Liberty" \
      io.openshift.expose-services="9080:http,9443:https" \
      io.openshift.tags="builder,liberty,websphere-liberty" \
      io.openshift.s2i.destination="/opt/s2i/destination" \
	  io.openshift.s2i.scripts-url="image:///opt/s2i/"

# Copy Scripts to build s2i
COPY assemble /opt/s2i/
COPY run /opt/s2i/
COPY usage /opt/s2i/
